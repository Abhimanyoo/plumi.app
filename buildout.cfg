# Plumi 4.4 buildout
#
# configures Plone + Plumi using WSGI, running under gunicorn
#
# Do not change this file unless you really have to.
# See site.cfg for configuration options
#
# see AUTHORS.txt for developers
#
# Copyright 2010 contributing authors.
#

[buildout]
extensions =
    buildout.dumppickedversions
    mr.developer
    buildout.bootstrap

dump-picked-versions-file = versions.cfg

extends =
    site.cfg
    build.cfg
    http://dist.plone.org/release/4.2-latest/versions.cfg
    http://good-py.appspot.com/release/plone.app.theming/1.0

parts =
    zeoserver
    plone
    zopeconf

    development-conf
    production-conf
    gunicorn
    ln
    
    backup
    backup-daily
    pack-monthly
    zserver-patch
        
    ploneftp

    transcodedaemon

    pcre-source
    x264-build
    ogg-build
    vorbis-build
    theora-build
    faac-build
    faad-build
    vpx-build
    lame-build
    ffmpeg-build
    ffmpeg
    qt-faststart

    lxml
    pcre-source
    nginx-build
    varnish-build
    cache

    main-config
    cache-config

    logrotate.conf

    supervisor
    zopepy
    omelette

    backup

    chown

    navtree-patch
    plumisite
    auto-install-plumisite

    upgrade-patch


versions = versions
sources = sources
auto-checkout = *
find-links =
    http://dist.plone.org/release/4.2-latest
    http://dist.plone.org/thirdparty

eggs =
    collective.transcode.recipe
    collective.transcode.daemon

[downloads]
varnish = http://downloads.sourceforge.net/varnish/varnish-2.1.3.tar.gz
nginx = http://sysoev.ru/nginx/nginx-0.7.43.tar.gz
haproxy = http://haproxy.1wt.eu/download/1.4/src/haproxy-1.4.18.tar.gz
ffmpeg = http://www.ffmpeg.org/releases/ffmpeg-0.10.3.tar.bz2
x264 = http://download.videolan.org/pub/videolan/x264/snapshots/x264-snapshot-20120513-2245-stable.tar.bz2
libogg = http://downloads.xiph.org/releases/ogg/libogg-1.3.0.tar.gz
libvorbis = http://downloads.xiph.org/releases/vorbis/libvorbis-1.3.3.tar.gz
libtheora = http://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.bz2
libfaac = http://downloads.sourceforge.net/faac/faac-1.28.tar.bz2
libfaad = http://downloads.sourceforge.net/faac/faad2-2.7.tar.bz2
liblame = http://downloads.sourceforge.net/project/lame/lame/3.99/lame-3.99.5.tar.gz?use_mirror=ohv
mp4v2 = http://mp4v2.googlecode.com/files/mp4v2-1.9.1.tar.bz2
libvpx = http://webm.googlecode.com/files/libvpx-v1.1.0.tar.bz2

# TODO: this should be actually in kgs
[versions]
#plumi.app = 4.3
#plumi.content = 4.3
#plumi.skin = 4.3
#plumi.locales = 4.3
collective.transcode.star = 0.14
collective.transcode.daemon = 0.10
collective.piwik.medielement = 0.2
collective.seeder = 1.1
#collective.contentlicensing = 2.2.1

# Default settings for ZEO clients.
[instance-settings]
zeo-client = true
zeo-address = ${site:zeo-address}
user = ${site:user}
effective-user = ${site:zope-user}
zeo-address = ${site:zeo-address}
zodb-cache-size-bytes = ${site:zodb-cache-size-bytes}
zeo-client-cache-size = ${site:zeo-client-cache-size}
zserver-threads = 2
debug-mode = off
shared-blob = on
http-force-connection-close = on
http-fast-listen = off
blob-storage = var/blobstorage
environment-vars = ${site:environment-vars}

eggs =
    Zope2
    Plone
    Pillow
    plumi.app
    plumi.skin
    collective.contentlicensing
    plone.app.caching
    ${site:eggs}
zcml =
    plone.app.caching
    plumi.app
    ${site:zcml}

[zeoserver]
effective-user = ${site:zeo-user}

[zopeconf]
recipe = collective.recipe.template
input = templates/zope.conf.in
output = ${buildout:parts-directory}/plone/etc/zope.conf

[development-conf]
recipe = collective.recipe.template
input = templates/development.in
output = ${buildout:directory}/development.ini

[production-conf]
recipe = collective.recipe.template
input = templates/production.in
output = ${buildout:directory}/production.ini

[plone]
recipe = plone.recipe.zope2instance
eggs =
    PasteScript
    WebError
    repoze.retry
    repoze.tm2
    repoze.vhm
scripts = paster

[supervisor-settings]
user = ${site:supervisor-user}
password = ${site:supervisor-pass}

[build]
cpu = i686
target = linux26

extra-cflags="-I${buildout:directory}/parts/x264-build/include
               -I${buildout:directory}/parts/ogg-build/include
               -I${buildout:directory}/parts/theora-build/include
               -I${buildout:directory}/parts/lame-build/include
               -I${buildout:directory}/parts/faac-build/include
               -I${buildout:directory}/parts/faad-build/include
               -I${buildout:directory}/parts/vpx-build/include
               -I${buildout:directory}/parts/vorbis-build/include"

extra-ldflags="-L${buildout:directory}/parts/x264-build/lib
               -L${buildout:directory}/parts/ogg-build/lib
               -L${buildout:directory}/parts/theora-build/lib
               -L${buildout:directory}/parts/lame-build/lib
               -L${buildout:directory}/parts/faac-build/lib
               -L${buildout:directory}/parts/faad-build/lib
               -L${buildout:directory}/parts/vpx-build/lib
               -L${buildout:directory}/parts/vorbis-build/lib"

[navtree-patch]
recipe = collective.recipe.patch
egg = plone.app.layout==2.2.5
patches = ${buildout:directory}/patches/navtree.patch

[plumisite]
recipe = collective.recipe.scriptgen
cmd = ${buildout:directory}/bin/instance-debug 
arguments = run ${buildout:directory}/scripts/addPlumiSite ${site:portal-id} ${site:www-videoserver-name}

[auto-install-plumisite]
recipe = collective.recipe.cmd
on_install = true
on_update = false
cmds = ${buildout:directory}/bin/zeoserver start && ${buildout:directory}/bin/plumisite && ${buildout:directory}/bin/zeoserver stop
